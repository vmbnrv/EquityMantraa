version: "3.9"

services:
  traefik:
    image: traefik:v3.1
    command:
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.le.acme.httpchallenge=true"
      - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.le.acme.email=your-email@example.com"  # CHANGE THIS
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./letsencrypt:/letsencrypt

  ghost:
    image: ghost:5-alpine
    depends_on:
      - traefik
    environment:
      url: https://equitymantraa.com
      database__client: sqlite3
      database__connection__filename: /var/lib/ghost/content/data/ghost.db
      mail__transport: SMTP
      mail__options__host: smtp.example.com  # CHANGE TO YOUR SMTP
      mail__options__port: 587
      mail__options__auth__user: your-smtp-user  # CHANGE THIS
      mail__options__auth__pass: your-smtp-pass  # CHANGE THIS
    volumes:
      - ./ghost-content:/var/lib/ghost/content
      - ./ghost-content/themes/casper-local:/var/lib/ghost/current/content/themes/casper-custom
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ghost.rule=Host(`equitymantraa.com`) || Host(`www.equitymantraa.com`)"
      - "traefik.http.routers.ghost.entrypoints=websecure"
      - "traefik.http.routers.ghost.tls.certresolver=le"
      - "traefik.http.services.ghost.loadbalancer.server.port=2368"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.ghost-http.rule=Host(`equitymantraa.com`) || Host(`www.equitymantraa.com`)"
      - "traefik.http.routers.ghost-http.entrypoints=web"
      - "traefik.http.routers.ghost-http.middlewares=redirect-to-https"
    restart: unless-stopped
